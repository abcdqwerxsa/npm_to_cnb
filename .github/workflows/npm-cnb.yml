name: Sync to CNB Artifact Registry

on:
  workflow_dispatch:
    inputs:
      package_list:
        description: 'Package list (name:version,name:version)'
        required: true
        default: 'lodash:4.17.21,express:4.18.2'
      cnb_registry:
        description: 'CNB Registry URL'
        required: true
        default: 'https://npm.cnb.cool/nilpotenter/cloud-npm/-/packages/'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Sync packages to CNB
        env:
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œnpmä¼šè‡ªåŠ¨ä½¿ç”¨CNBä»“åº“
          NPM_CONFIG_REGISTRY: '${{ github.event.inputs.cnb_registry }}'
        run: |
          IFS=',' read -ra PACKAGES <<< "${{ github.event.inputs.package_list }}"
          
          for spec in "${PACKAGES[@]}"; do
            IFS=':' read -ra PARTS <<< "$spec"
            pkg_name="${PARTS[0]}"
            pkg_version="${PARTS[1]}"
            
            echo "ğŸ”„ Syncing $pkg_name@$pkg_version to CNB"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir temp_sync && cd temp_sync
            
            # ä»å®˜æ–¹æºä¸‹è½½åŒ…
            npm pack "${pkg_name}@${pkg_version}" --registry=https://registry.npmjs.org
            
            # è§£å‹
            tar -xf *.tgz
            cd package
            
            # ğŸ”‘ åœ¨åŒ…ç›®å½•ä¸­è®¾ç½®CNBè®¤è¯
            cat > .npmrc << EOF
            registry=${{ github.event.inputs.cnb_registry }}
            always-auth=true
            //npm.cnb.cool/nilpotenter/cloud-npm/-/packages/:_authToken=$CNB_TOKEN
            EOF
            
            # å‘å¸ƒåˆ°CNBåˆ¶å“ä»“åº“
            npm publish --loglevel=verbose
            
            cd ../..
            rm -rf temp_sync
            echo "âœ… Synced to CNB: $pkg_name@$pkg_version"
          done
          
          echo "ğŸ‰ All packages synced to CNB successfully!"
