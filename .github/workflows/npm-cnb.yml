name: Sync to CNB Artifact Registry

on:
  workflow_dispatch:
    inputs:
      package_list:
        description: 'Package list (name:version,name:version)'
        required: true
        default: 'lodash:4.17.21,@anthropic-ai/claude-code:2.0.1'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Sync packages to CNB
        env:
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
        run: |
          echo "=== å¼€å§‹åŒæ­¥åˆ° CNB ==="
          
          # åˆ›å»ºä¸»è®¤è¯æ–‡ä»¶
          cat > /tmp/main.npmrc << EOF
          registry=https://npm.cnb.cool/nilpotenter/cloud-npm/-/packages/
          //npm.cnb.cool/nilpotenter/cloud-npm/-/packages/:_authToken=$CNB_TOKEN
          always-auth=true
          EOF
          
          IFS=',' read -ra PACKAGES <<< "${{ github.event.inputs.package_list }}"
          
          for spec in "${PACKAGES[@]}"; do
            IFS=':' read -ra PARTS <<< "$spec"
            pkg_name="${PARTS[0]}"
            pkg_version="${PARTS[1]}"
            
            echo "--- å¤„ç†: $pkg_name@$pkg_version ---"
            
            # ğŸ”´ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ curl ç›´æ¥æ£€æŸ¥åŒ…æ˜¯å¦å­˜åœ¨
            echo "æ£€æŸ¥åŒ…æ˜¯å¦å­˜åœ¨..."
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://npm.cnb.cool/nilpotenter/cloud-npm/-/packages/$pkg_name/$pkg_version" \
              -H "Authorization: Bearer $CNB_TOKEN")
            
            if [ "$response" = "200" ]; then
              echo "â­ï¸  åŒ…å·²å­˜åœ¨: $pkg_name@$pkg_version (HTTP $response)"
              continue
            else
              echo "âœ… åŒ…ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—® (HTTP $response)ï¼Œå¼€å§‹åŒæ­¥..."
            fi
            
            # åŒæ­¥æµç¨‹
            mkdir temp_sync && cd temp_sync
            echo "ä¸‹è½½åŒ…..."
            npm pack "${pkg_name}@${pkg_version}" --registry=https://registry.npmjs.org
            
            echo "è§£å‹åŒ…..."
            tar -xf *.tgz
            cd package
            
            echo "è®¾ç½®è®¤è¯..."
            cp /tmp/main.npmrc .npmrc
            
            echo "å‘å¸ƒåŒ…..."
            AUTHORIZED=true npm publish --ignore-scripts --loglevel=info
            
            cd ../..
            rm -rf temp_sync
            echo "âœ… åŒæ­¥å®Œæˆ: $pkg_name@$pkg_version"
          done
          
          rm -f /tmp/main.npmrc
          echo "ğŸ‰ æ‰€æœ‰åŒ…å¤„ç†å®Œæˆ!"
